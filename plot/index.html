<!DOCTYPE html>
<html>
<head>
    <title>WASM Plot</title>
    <style>
        canvas { border: 1px solid #ccc; }
        .slider-container { margin: 20px; }
    </style>
</head>
<body>
    <div class="slider-container">
        <input type="range" id="slider" min="-5" max="5" step="0.1" value="1">
        <span id="a-value">a = 1.0</span>
    </div>
    <canvas id="canvas" width="700" height="600"></canvas>

    <script type="module">
        import init, { CurveData } from './pkg/plot.js';

        class Plotter {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.curveData = CurveData.new();
                this.initCanvas();
            }

            initCanvas() {
                // 重置变换
                this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                
                // 应用新变换：逻辑坐标 [-1,1] 映射到 Canvas 像素坐标
                const scaleX = this.canvas.width / 2;
                const scaleY = this.canvas.height / 2;
                this.ctx.transform(
                    scaleX, 0,
                    0, -scaleY,
                    scaleX, scaleY
                );
                
                // 设置可视线宽
                this.ctx.lineWidth = 2 / scaleX; // 逻辑坐标系的2单位对应像素宽度
            }

            draw() {
                this.ctx.clearRect(-1, -1, 2, 2);
                
                // 绘制坐标轴
                this.drawAxes();
                
                // 绘制曲线
                this.drawCurve(this.curveData.neg_points_ptr(), 'green');
                this.drawCurve(this.curveData.pos_points_ptr(), 'red');
            }

            drawCurve(ptr, baseColor) {
                const points = new Float64Array(
                    wasm.memory.buffer,
                    ptr,
                    this.curveData.len() * 2
                );

                // 调试输出
                console.log(`${label} points:`, points.slice(0, 4)); // 显示前两个点

                // 创建渐变
                // const gradient = this.ctx.createLinearGradient(-1, 0, 1, 0);
                // gradient.addColorStop(0, '#8f8');   // 浅绿
                // gradient.addColorStop(0.4, '#0f0'); // 纯绿
                // gradient.addColorStop(0.5, '#000'); // 纯黑
                // gradient.addColorStop(0.6, '#f00'); // 纯红
                // gradient.addColorStop(1, '#f88');   // 浅红
                this.ctx.strokeStyle = '#f00'; // 纯红色
                this.ctx.lineWidth = 0.02;     // 逻辑坐标线宽

                this.ctx.beginPath();
                for (let i = 0; i < points.length; i += 2) {
                    const x = points[i];
                    const y = points[i + 1];
                    if (i === 0) this.ctx.moveTo(x, y);
                    else this.ctx.lineTo(x, y);
                }
                this.ctx.strokeStyle = gradient;
                this.ctx.lineWidth = 0.01;
                this.ctx.stroke();
            }

            drawAxes() {
                this.ctx.save();
                this.ctx.strokeStyle = '#666';
                this.ctx.setLineDash([0.02, 0.02]);
                
                // X轴
                this.ctx.beginPath();
                this.ctx.moveTo(-1, 0);
                this.ctx.lineTo(1, 0);
                this.ctx.stroke();
                
                // Y轴
                this.ctx.beginPath();
                this.ctx.moveTo(0, -1);
                this.ctx.lineTo(0, 1);
                this.ctx.stroke();
                
                this.ctx.restore();
            }
        }

        async function main() {
            await init();
            const plotter = new Plotter();
            
            document.getElementById('slider').addEventListener('input', (e) => {
                const a = parseFloat(e.target.value);
                document.getElementById('a-value').textContent = `a = ${a.toFixed(1)}`;
                plotter.curveData.compute(a);
                plotter.draw();
            });

            // 初始绘制
            plotter.curveData.compute(1.0);
            plotter.draw();
        }

        main();
    </script>
</body>
</html>